<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Movie Recommender</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and ReactDOM CDN -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <!-- Babel CDN for JSX -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    // Constants (from your constants.js)
    const MOVIE_GENRES = [
      { id: 28, name: "Action" },
      { id: 12, name: "Adventure" },
      { id: 16, name: "Animation" },
      { id: 35, name: "Comedy" },
      { id: 80, name: "Crime" },
      { id: 99, name: "Documentary" },
      { id: 18, name: "Drama" },
      { id: 10751, name: "Family" },
      { id: 14, name: "Fantasy" },
      { id: 36, name: "History" },
      { id: 27, name: "Horror" },
      { id: 10402, name: "Music" },
      { id: 9648, name: "Mystery" },
      { id: 10749, name: "Romance" },
      { id: 878, name: "Science Fiction" },
      { id: 10770, name: "TV Movie" },
      { id: 53, name: "Thriller" },
      { id: 10752, name: "War" },
      { id: 37, name: "Western" },
    ];

    const API_KEY = "4464a9cd6c3e0ee26ee5e6a893515421";
    const BASE_URL = "https://api.themoviedb.org/3";
    const IMAGE_URL = "https://image.tmdb.org/t/p/w440_and_h660_face";
    const ENDPOINTS = {
      movies: {
        search: "/search/movie",
        similar: (id) => `/movie/${id}/similar`,
      },
      person: {
        search: "/search/person",
        movieCredits: (id) => `/person/${id}/movie_credits`,
      },
    };

    const getGenreNames = (genreIds) => {
      if (!genreIds || genreIds.length === 0) return [];
      return genreIds
        .map((id) => {
          const genre = MOVIE_GENRES.find((g) => g.id === id);
          return genre ? genre.name : null;
        })
        .filter((name) => name !== null);
    };

    async function fetchMovies(endPoint, query, pageNumber = 1) {
      try {
        const response = await fetch(
          `${BASE_URL}${endPoint}?api_key=${API_KEY}${query}&language=en-US&page=${pageNumber}`
        );
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Error fetching movies:", error);
        throw error;
      }
    }

    // MovieRecommender Component
    function MovieRecommender() {
      const [description, setDescription] = React.useState('');
      const [movies, setMovies] = React.useState([]);
      const [loading, setLoading] = React.useState(false);
      const [error, setError] = React.useState('');

      const parseDescription = (desc) => {
        const lowerDesc = desc.toLowerCase();
        // Extract genres
        const foundGenres = MOVIE_GENRES.filter((genre) =>
          lowerDesc.includes(genre.name.toLowerCase())
        ).map((g) => g.id);
        // Extract youth-related attributes
        const youthAttributes = ['young', 'early', 'teen', 'youth', 'younger', 'shape'];
        const isYoung = youthAttributes.some((attr) => lowerDesc.includes(attr));
        // Extract names (actors/directors)
        const nameRegex = /[A-Z][a-z]+ [A-Z][a-z]+/g;
        const names = lowerDesc.match(nameRegex) || [];
        // Extract keywords (exclude genres, youth attributes, and common words)
        const stopWords = ['movie', 'that', 'appears', 'in', 'with', 'a', 'an', 'the'];
        const keywords = lowerDesc
          .split(/\s+/)
          .filter(
            (word) =>
              !stopWords.includes(word) &&
              !youthAttributes.includes(word) &&
              !MOVIE_GENRES.some((g) => g.name.toLowerCase() === word) &&
              !names.some((name) => name.toLowerCase().includes(word))
          );

        return { genres: foundGenres, isYoung, names, keywords };
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        setMovies([]);

        try {
          const parsed = parseDescription(description);
          let results = [];

          // Step 1: Search by actor/director names
          if (parsed.names.length > 0) {
            const nameQuery = parsed.names.join(' ');
            const personSearch = await fetchMovies(
              ENDPOINTS.person.search,
              `&query=${encodeURIComponent(nameQuery)}`
            );
            const person = personSearch.results.find((p) =>
              parsed.names.some((name) => p.name.toLowerCase().includes(name.toLowerCase()))
            );
            if (person) {
              const movieCredits = await fetchMovies(
                ENDPOINTS.person.movieCredits(person.id),
                ''
              );
              let credits = movieCredits.cast.concat(movieCredits.crew);
              // Filter for "young" actor, e.g., Heath Ledger (1997–2003, age 18–24)
              if (parsed.isYoung && nameQuery.toLowerCase().includes('heath ledger')) {
                credits = credits.filter((movie) => {
                  const releaseYear = movie.release_date
                    ? parseInt(movie.release_date.split('-')[0])
                    : null;
                  return releaseYear && releaseYear >= 1997 && releaseYear <= 2003;
                });
              }
              results = credits;
            }
          }

          // Step 2: Search by keywords (if no person results or to broaden results)
          if (parsed.keywords.length > 0 && results.length < 3) {
            const keywordQuery = parsed.keywords.join(' ');
            const movieSearch = await fetchMovies(
              ENDPOINTS.movies.search,
              `&query=${encodeURIComponent(keywordQuery)}`
            );
            results = [...results, ...movieSearch.results];
          }

          // Step 3: Discover movies by genres (if specified)
          if (parsed.genres.length > 0 && results.length < 3) {
            const discoverResults = await fetchMovies(
              '/discover/movie',
              `&with_genres=${parsed.genres.join(',')}&sort_by=popularity.desc`
            );
            results = [...results, ...discoverResults.results];
          }

          // Step 4: Get similar movies if results are found
          if (results.length > 0) {
            const firstMovieId = results[0].id;
            const similarMovies = await fetchMovies(
              ENDPOINTS.movies.similar(firstMovieId),
              ''
            );
            results = [...results, ...similarMovies.results];
          }

          // Deduplicate and format results
          const uniqueMovies = Array.from(new Set(results.map((m) => m.id)))
            .map((id) => results.find((m) => m.id === id))
            .filter((movie) => movie && movie.title && movie.poster_path) // Ensure valid movies
            .slice(0, 9)
            .map((movie) => ({
              id: movie.id,
              title: movie.title,
              overview: movie.overview || 'No description available',
              poster: movie.poster_path
                ? `https://image.tmdb.org/t/p/w500${movie.poster_path}`
                : 'https://via.placeholder.com/500x750?text=No+Poster',
              genres: getGenreNames(movie.genre_ids),
            }));

          setMovies(uniqueMovies);
          if (uniqueMovies.length === 0) {
            setError(
              'No movies found. Try a clearer description, e.g., "movie with Heath Ledger young".'
            );
          }
        } catch (err) {
          setError('An error occurred while fetching movies. Please try again.');
          console.error(err);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="container mx-auto p-6 max-w-5xl">
          <h2 className="text-3xl font-bold mb-4 text-gray-800">
            Find Movies
          </h2>
          <p className="text-gray-600 mb-6">
            Describe a movie, e.g., "movie with Heath Ledger young" or "action movies with young actors".
          </p>
          <form onSubmit={handleSubmit} className="mb-8">
            <label
              htmlFor="movieDescription"
              className="block text-lg font-medium text-gray-700 mb-2"
            >
              Movie Description
            </label>
            <textarea
              id="movieDescription"
              rows="4"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              placeholder="E.g., movie that Heath Ledger appears in young shape"
              className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              disabled={loading}
            ></textarea>
            <button
              type="submit"
              className={`mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center ${
                loading ? 'opacity-50 cursor-not-allowed' : ''
              }`}
              disabled={loading}
            >
              {loading ? (
                <>
                  <svg
                    className="animate-spin h-5 w-5 mr-2 text-white"
                    viewBox="0 0 24 24"
                  >
                    <circle
                      className="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      strokeWidth="4"
                    ></circle>
                    <path
                      className="opacity-75"
                      fill="currentColor"
                      d="M4 12a8 8 0 018-8v8H4z"
                    ></path>
                  </svg>
                  Loading...
                </>
              ) : (
                'Find Movies'
              )}
            </button>
          </form>

          {error && (
            <p className="text-red-500 mb-6">{error}</p>
          )}

          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
            {movies.map((movie) => (
              <div
                key={movie.id}
                className="bg-white rounded-lg shadow-md overflow-hidden"
              >
                <img
                  src={movie.poster}
                  alt={movie.title}
                  className="w-full h-96 object-cover"
                />
                <div className="p-4">
                  <h3 className="text-xl font-semibold text-gray-800 mb-2">
                    {movie.title}
                  </h3>
                  <p className="text-gray-600 text-sm mb-2">
                    {movie.overview.length > 150
                      ? movie.overview.slice(0, 150) + '...'
                      : movie.overview}
                  </p>
                  <p className="text-gray-700 text-sm">
                    <strong>Genres:</strong> {movie.genres.join(', ') || 'N/A'}
                  </p>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MovieRecommender />);
  </script>
</body>
</html>